<div class="chat-container">
  <!-- Sidebar -->
  <div class="chat-sidebar">
    <div class="sidebar-header">
      <h2>Conversations</h2>
      <button class="btn-new-chat" (click)="createNewConversation()">+ New Chat</button>
    </div>

    <div class="conversation-list">
      @for (conv of conversations; track conv.id) {
        <div
          class="conversation-item"
          [class.active]="currentConversation?.id === conv.id"
          (click)="loadConversation(conv.id)"
        >
          <div class="conv-content">
            <div class="conv-title">{{ conv.title }}</div>
            <div class="conv-meta">{{ conv.message_count }} messages</div>
          </div>
        </div>
      }

      @if (conversations.length === 0) {
        <div class="empty-state">
          <p>No conversations yet. Start chatting!</p>
        </div>
      }
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-main">
    @if (currentConversation) {
      <div class="chat-header">
        <h2>{{ currentConversation.title }}</h2>
        @if (currentConversation.topic) {
          <p>{{ currentConversation.topic }}</p>
        }
      </div>
    }

    <div class="chat-messages" #messagesContainer (scroll)="onScroll()">
      <div class="messages-wrapper">
        @if (messages.length === 0) {
          <div class="welcome-message">
            <h2>How can I help you today?</h2>
          </div>
        }

        @for (msg of messages; track msg.id) {
          <div
            class="message"
            [class.user-message]="msg.role === 'user'"
            [class.assistant-message]="msg.role === 'assistant'"
          >
            <div class="message-content">
              <div class="message-text" [innerHTML]="parseMarkdown(msg.content)"></div>
              <div class="message-time">{{ formatTime(msg.created_at) }}</div>
            </div>
          </div>
        }

        @if (sendingMessage) {
          <div class="message assistant-message">
            <div class="message-content">
              <div class="message-text typing">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Scroll to bottom button -->
      @if (showScrollButton) {
        <button
          class="scroll-to-bottom-btn"
          (click)="scrollToBottomClick()"
          aria-label="Scroll to bottom"
          type="button"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 20 20"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M10 14L5 9L6.4 7.6L10 11.2L13.6 7.6L15 9L10 14Z" fill="currentColor" />
          </svg>
        </button>
      }
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
      <form (ngSubmit)="sendMessage()" class="chat-input-form">
        <input
          type="text"
          [(ngModel)]="messageText"
          name="message"
          placeholder="Message AI Companion"
          [disabled]="sendingMessage || !currentConversation"
          class="chat-input"
          autocomplete="off"
        />
        <button
          type="submit"
          class="btn-send"
          [disabled]="!messageText.trim() || sendingMessage || !currentConversation"
          aria-label="Send message"
        >
          @if (!sendingMessage) {
            <span>â†‘</span>
          } @else {
            <span class="spinner-small"></span>
          }
        </button>
      </form>
    </div>
  </div>
</div>
